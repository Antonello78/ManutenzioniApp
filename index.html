<!DOCTYPE html>
<html lang="it">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Calcolo Manodopera (Sincronizzato)</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
Â  Â  <meta name="mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black">
Â  Â  <meta name="apple-mobile-web-app-title" content="Calcolo Manodopera">
Â  Â  <link rel="manifest" href="data:application/manifest+json,{'name':'Calcolo Manodopera','short_name':'CalcoloMan','description':'Calcolo manodopera forfettario','start_url':'index.html','display':'standalone','background_color':'#f7f9fc','theme_color':'#1e40af','icons':[{'src':'https://placehold.co/192x192/4F46E5/ffffff?text=C','sizes':'192x192','type':'image/png'}]}">
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fc;
Â  Â  Â  Â  Â  Â  padding-top: 1rem;
Â  Â  Â  Â  Â }
Â  Â  Â  Â  /* Style specific to hide the number input arrows */
Â  Â  Â  Â  input[type=number]::-webkit-inner-spin-button,
Â  Â  Â  Â  input[type=number]::-webkit-outer-spin-button {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type=number] {
Â  Â  Â  Â  Â  Â  -moz-appearance: textfield;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ğŸ› ï¸ CSS per stampa in pagina unica AGGRESSIVA ğŸ› ï¸ */
Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  .no-print {
Â  Â  Â  Â  Â  Â  Â  Â  display: none !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  #app {
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: none !important;
Â  Â  Â  Â  Â  Â  Â  Â  border: none !important;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: none !important;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0 !important;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0.2rem !important;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 297mm;
Â  Â  Â  Â  Â  Â  Â  Â  width: 210mm;
Â  Â  Â  Â  Â  Â  Â  Â  transform: scale(0.75);
Â  Â  Â  Â  Â  Â  Â  Â  transform-origin: top left;
Â  Â  Â  Â  Â  Â  Â  Â  page-break-inside: avoid !important;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  .print-avoid-break,
Â  Â  Â  Â  Â  Â  .print-avoid-break *,
Â  Â  Â  Â  Â  Â  .flex {
Â  Â  Â  Â  Â  Â  Â  Â  page-break-inside: avoid !important;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  @page {
Â  Â  Â  Â  Â  Â  Â  Â  size: A4 portrait;
Â  Â  Â  Â  Â  Â  Â  Â  margin: 0.2cm !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="p-4 sm:p-8">
Â  Â  <div id="app" class="max-w-xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">

Â  Â  Â  Â  <div id="unified-header" class="mb-6 border-b pb-2 text-center no-print">
Â  Â  Â  Â  Â  Â  <img src="LOGO ANTONELLO.png" alt="Logo Aziendale" class="h-24 object-contain mx-auto mb-2">
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">Ultimo aggiornamento: <span id="dataStampa"></span></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="input-section">
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-700 mb-4 no-print">Dettagli Intervento Corrente</h2>
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="nIntervento" class="block text-sm font-medium text-gray-600">NÂ° Intervento</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="nIntervento" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="Es. 075/25" readonly> </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="dataIntervento" class="block text-sm font-medium text-gray-600">Data</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="date" id="dataIntervento" onchange="calcolaManodopera()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="nomeScuola" class="block text-sm font-medium text-gray-600">Nome Scuola</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="nomeScuola" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="Istituto Comprensivo G. Pascoli">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="plessoEdificio" class="block text-sm font-medium text-gray-600">Plesso/Edificio</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="plessoEdificio" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="Sede Centrale / Plesso Via Roma">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="border-t border-gray-200 pt-4 mt-4"></div>

Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="oraInizio" class="block text-sm font-medium text-gray-600">Ora Inizio Intervento (HH:MM)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="oraInizio" value="09:00" onchange="calcolaManodopera()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="oraFine" class="block text-sm font-medium text-gray-600">Ora Fine Intervento (HH:MM)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="time" id="oraFine" value="10:15" onchange="calcolaManodopera()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="numOperai" class="block text-sm font-medium text-gray-600">Numero Operai Coinvolti</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="numOperai" value="1" min="1" onchange="calcolaManodopera()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="flex items-center pt-2 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="flagUrgenza" type="checkbox" onchange="calcolaManodopera()" class="h-5 w-5 text-red-600 border-gray-300 rounded">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="flagUrgenza" class="ml-3 block text-base font-medium text-red-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Marca come "Urgenza Immediata" (48 â‚¬/h)
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="errorMsg" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden no-print" role="alert">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="successMsg" class="mt-4 p-3 bg-green-100 border border-green-400 text-green-700 rounded-lg hidden no-print" role="alert">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="mt-8 pt-6 border-t border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-semibold text-gray-700 mb-4 no-print">Dettaglio Calcolo e Totale</h2>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="print-avoid-break">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="riepilogoDati" class="space-y-2 text-gray-700 p-4 border rounded-lg bg-gray-50 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-2 border-b pb-1 text-blue-700">Dati Intervento</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-base">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">NÂ° Intervento:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="resNIntervento" class="font-semibold text-gray-800">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-base">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Data:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="resData" class="font-semibold text-gray-800">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-base">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Scuola/Plesso:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="resScuola" class="font-semibold text-gray-800 text-right max-w-[60%]">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-base">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Orario Lavorato:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="resOrario" class="font-semibold text-gray-800">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between text-base">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Operai:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="resOperai" class="font-semibold text-gray-800">---</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-2 text-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Tariffa Oraria Applicata:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="tariffaOraria" class="font-semibold text-gray-800">38,00 â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Tempo Effettivo Lavorato (Minuti/Uomo):</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="minutiEffettivi" class="font-medium">135 min</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-lg border-b pb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Tempo Fatturabile (Arrotondato 15 min):</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="minutiFatturabili" class="font-semibold text-blue-600">135 min</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-lg pt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Costo di Uscita (Incl. 1Âª Ora):</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="costoUscita" class="font-semibold text-gray-800">75,00 â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center text-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium">Costo Manodopera Aggiuntiva:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="costoAggiuntivo" class="font-semibold text-gray-800">0,00 â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 p-4 bg-blue-100 border-2 border-blue-400 rounded-xl flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl font-bold text-blue-800">TOTALE MANODOPERA (â‚¬):</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="totaleManodopera" class="text-3xl font-extrabold text-blue-800">75,00 â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="archivioInterventi" class="hidden mt-4">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-700 mb-4">ğŸ“‚ Archivio Interventi Salvati</h2>

Â  Â  Â  Â  Â  Â  <div id="listaInterventi" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500">Caricamento interventi in corso...</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="border-t border-gray-200 mt-6 pt-4 no-print"></div>

Â  Â  Â  Â  <div class="mt-4 space-y-3 no-print">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-semibold text-gray-700">Opzioni Report e Archivio</h3>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="emailDestinatario" class="block text-sm font-medium text-gray-600">Email di Destinazione (default)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="emailDestinatario" onchange="salvaEmail()" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 text-lg" placeholder="amministrazione@scuola.it">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mt-6 flex flex-col space-y-3 sm:space-y-0 sm:space-x-3 no-print">

Â  Â  Â  Â  Â  Â  <button onclick="toggleArchivio()" id="btnToggleArchivio" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 w-full sm:w-1/2 mx-auto mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Gestione Archivio
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <div id="action-buttons" class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="salvaIntervento()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Salva Intervento
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="stampaRiepilogo()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Stampa Riepilogo / Crea PDF
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="inviaReport()" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Invia Report (Email)
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <p class="mt-6 text-xs text-gray-400 text-center no-print">
Â  Â  Â  Â  Â  Â  Orario Ordinario: 08:00 - 17:00. Il calcolo arrotonda i minuti di manodopera per eccesso al quarto d'ora superiore.
Â  Â  Â  Â  </p>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // Costanti
Â  Â  Â  Â  const COSTO_USCITA = 75.00;
Â  Â  Â  Â  const TARIFFA_ORDINARIA = 38.00; // â‚¬/ora
Â  Â  Â  Â  const TARIFFA_STRAORDINARIO = 48.00; // â‚¬/ora
Â  Â  Â  Â  const ORARIO_INIZIO_ORD = 8 * 60; // 08:00 in minuti
Â  Â  Â  Â  const ORARIO_FINE_ORD = 17 * 60; // 17:00 in minuti

Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  function parseTime(timeString) {
Â  Â  Â  Â  Â  Â  const [hours, minutes] = timeString.split(':').map(Number);
Â  Â  Â  Â  Â  Â  return (hours * 60) + minutes;
Â  Â  Â  Â  }

Â  Â  Â  Â  function formatDate(dateString) {
Â  Â  Â  Â  Â  Â  if (!dateString) return 'N/A';
Â  Â  Â  Â  Â  Â  const date = new Date(dateString + 'T00:00:00');
Â  Â  Â  Â  Â  Â  Â if (isNaN(date.getTime())) return 'N/A';
Â  Â  Â  Â  Â  Â  const options = { year: 'numeric', month: 'long', day: 'numeric' };
Â  Â  Â  Â  Â  Â  return date.toLocaleDateString('it-IT', options);
Â  Â  Â  Â  }

Â  Â  Â  Â  function hideMessage(type) {
Â  Â  Â  Â  Â  Â  Â if (type === 'error') {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('errorMsg').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â } else if (type === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('successMsg').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showMessage(type, message) {
Â  Â  Â  Â  Â  Â  hideMessage(type === 'error' ? 'success' : 'error');
Â  Â  Â  Â  Â  Â  const msgElement = document.getElementById(type === 'error' ? 'errorMsg' : 'successMsg');
Â  Â  Â  Â  Â  Â  msgElement.textContent = message;
Â  Â  Â  Â  Â  Â  msgElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  if (type === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => msgElement.classList.add('hidden'), 5000);
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * FUNZIONE: Carica il prossimo numero sequenziale dal Server Vercel
Â  Â  Â  Â  Â * @param {boolean} forceNew - Forza il caricamento del prossimo numero, anche se ne Ã¨ giÃ  presente uno.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadNextNIntervento(forceNew = false) {
Â  Â  Â  Â  Â  Â  const nInterventoInput = document.getElementById('nIntervento');
Â  Â  Â  Â  Â  Â  const CURRENT_YEAR = new Date().getFullYear().toString().substring(2);
             nInterventoInput.value = 'Caricamento...'; // Mostra stato di caricamento

Â  Â  Â  Â  Â  Â  // Impedisce il ricalcolo se si sta modificando un intervento esistente
Â  Â  Â  Â  Â  Â  if (!forceNew && nInterventoInput.dataset.editId) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // CORREZIONE 1: Chiamata all'API Vercel (prefisso /api/)
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/getNextNumber?year=' + CURRENT_YEAR);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
                    const errorData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.error || `Errore Server (Stato: ${response.status}).`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CORREZIONE 2: Usa 'data.nIntervento' che arriva formattato dal server
Â  Â  Â  Â  Â  Â  Â  Â  if (data.nIntervento) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nInterventoInput.value = data.nIntervento;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nInterventoInput.dataset.id = null; // Rimuove l'ID di modifica
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', "Il server non ha restituito un NÂ° Intervento valido.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `Errore Server: ${error.message} - Impossibile caricare il NÂ° Intervento. Verifica i log di Vercel.`);
Â  Â  Â  Â  Â  Â  Â  Â  nInterventoInput.value = `!!! Errore !!! /${CURRENT_YEAR}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Initialization and Cleanup ---

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Inizializza i campi di input all'avvio o dopo il salvataggio.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function initializeInputs() {
Â  Â  Â  Â  Â  Â  // Data di stampa corrente
Â  Â  Â  Â  Â  Â  document.getElementById('dataStampa').textContent = new Date().toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

Â  Â  Â  Â  Â  Â  // Imposta la data corrente se non presente
Â  Â  Â  Â  Â  Â  const dataInput = document.getElementById('dataIntervento');
Â  Â  Â  Â  Â  Â  if (!dataInput.value) {
Â  Â  Â  Â  Â  Â  Â  Â  dataInput.valueAsDate = new Date();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Imposta 1 come operai se vuoto
Â  Â  Â  Â  Â  Â  const numOperaiInput = document.getElementById('numOperai');
Â  Â  Â  Â  Â  Â  if (parseInt(numOperaiInput.value) < 1 || isNaN(parseInt(numOperaiInput.value))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â numOperaiInput.value = '1';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Carica l'email predefinita
Â  Â  Â  Â  Â  Â  document.getElementById('emailDestinatario').value = localStorage.getItem('defaultEmail') || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Carica il prossimo numero intervento dal server
Â  Â  Â  Â  Â  Â  await loadNextNIntervento(true);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Funzione per pulire i campi (chiamata dopo il salvataggio)
Â  Â  Â  Â  async function resetFields() {
Â  Â  Â  Â  Â  Â  Â document.getElementById('nomeScuola').value = '';
Â  Â  Â  Â  Â  Â  Â document.getElementById('plessoEdificio').value = '';
Â  Â  Â  Â  Â  Â  Â document.getElementById('oraInizio').value = '09:00';
Â  Â  Â  Â  Â  Â  Â document.getElementById('oraFine').value = '10:15';
Â  Â  Â  Â  Â  Â  Â document.getElementById('flagUrgenza').checked = false;
             document.getElementById('nIntervento').dataset.id = ''; // Pulisce l'ID di modifica
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â // Carica il prossimo NÂ° dal server
Â  Â  Â  Â  Â  Â  Â await initializeInputs();
Â  Â  Â  Â  Â  Â  Â calcolaManodopera();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Calculation (NO MODIFICHE QUI) ---

Â  Â  Â  Â  function calcolaManodopera() {
Â  Â  Â  Â  Â  Â  hideMessage('error');
Â  Â  Â  Â  Â  Â  hideMessage('success');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ... (logica di calcolo omessa per brevitÃ , non toccata) ...
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const oraInizioInput = document.getElementById('oraInizio').value;
Â  Â  Â  Â  Â  Â  const oraFineInput = document.getElementById('oraFine').value;
Â  Â  Â  Â  Â  Â  const numOperai = parseInt(document.getElementById('numOperai').value) || 1;
Â  Â  Â  Â  Â  Â  document.getElementById('numOperai').value = numOperai;

Â  Â  Â  Â  Â  Â  const flagUrgenza = document.getElementById('flagUrgenza').checked;

Â  Â  Â  Â  Â  Â  const nIntervento = document.getElementById('nIntervento').value;
Â  Â  Â  Â  Â  Â  Â const dataIntervento = document.getElementById('dataIntervento').value;
Â  Â  Â  Â  Â  Â  const nomeScuola = document.getElementById('nomeScuola').value;
Â  Â  Â  Â  Â  Â  const plessoEdificio = document.getElementById('plessoEdificio').value;

Â  Â  Â  Â  Â  Â  function resetResults() {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totaleManodopera').textContent = '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tariffaOraria').textContent = '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('minutiEffettivi').textContent = '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('minutiFatturabili').textContent = '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('costoAggiuntivo').textContent = '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('costoUscita').textContent = COSTO_USCITA.toFixed(2) + ' â‚¬';Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('totaleManodopera').textContent = COSTO_USCITA.toFixed(2) + ' â‚¬';

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resNIntervento').textContent = nIntervento || '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resData').textContent = formatDate(dataIntervento) || '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resScuola').textContent = (nomeScuola || 'N/A') + (plessoEdificio ? ' / ' + plessoEdificio : '');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resOrario').textContent = (oraInizioInput && oraFineInput) ? oraInizioInput + ' - ' + oraFineInput : '---';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('resOperai').textContent = numOperai + (flagUrgenza ? ' (URGENZA)' : '');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!oraInizioInput || !oraFineInput || isNaN(numOperai) || numOperai < 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â resetResults();
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const oraInizioMinuti = parseTime(oraInizioInput);
Â  Â  Â  Â  Â  Â  const oraFineMinuti = parseTime(oraFineInput);

Â  Â  Â  Â  Â  Â  if (oraFineMinuti <= oraInizioMinuti) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', "L'Ora Fine deve essere successiva all'Ora Inizio.");
Â  Â  Â  Â  Â  Â  Â  Â  resetResults();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const durataMinutiEffettiva = oraFineMinuti - oraInizioMinuti;
Â  Â  Â  Â  Â  Â  const minutiManodoperaEffettivi = durataMinutiEffettiva * numOperai;
Â  Â  Â  Â  Â  Â  const minutiFatturabili = Math.ceil(minutiManodoperaEffettivi / 15) * 15;

Â  Â  Â  Â  Â  Â  let tariffaOraria = TARIFFA_ORDINARIA;

Â  Â  Â  Â  Â  Â  if (flagUrgenza || oraInizioMinuti < ORARIO_INIZIO_ORD || oraFineMinuti > ORARIO_FINE_ORD) {
Â  Â  Â  Â  Â  Â  Â  Â  tariffaOraria = TARIFFA_STRAORDINARIO;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const minutiOltre60 = Math.max(0, minutiFatturabili - 60);

Â  Â  Â  Â  Â  Â  const oreAggiuntiveDecimali = minutiOltre60 / 60;
Â  Â  Â  Â  Â  Â  const costoManodoperaAggiuntiva = oreAggiuntiveDecimali * tariffaOraria;

Â  Â  Â  Â  Â  Â  const totaleManodopera = COSTO_USCITA + costoManodoperaAggiuntiva;
Â  Â  Â  Â  Â  Â  const totaleManodoperaArrotondato = parseFloat(totaleManodopera.toFixed(2));

Â  Â  Â  Â  Â  Â  document.getElementById('tariffaOraria').textContent = tariffaOraria.toFixed(2) + ' â‚¬/ora';
Â  Â  Â  Â  Â  Â  document.getElementById('minutiEffettivi').textContent = durataMinutiEffettiva + ' min x ' + numOperai + ' op = ' + minutiManodoperaEffettivi + ' min/uomo';

Â  Â  Â  Â  Â  Â  let minutiFatturabiliDesc = minutiFatturabili + ' min/uomo';
Â  Â  Â  Â  Â  Â  if (minutiFatturabili > 60) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  minutiFatturabiliDesc += ` (${minutiOltre60} min oltre la 1Âª ora)`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  minutiFatturabiliDesc += ` (1Âª ora inclusa o non superata)`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('minutiFatturabili').textContent = minutiFatturabiliDesc;
Â  Â  Â  Â  Â  Â  document.getElementById('costoUscita').textContent = COSTO_USCITA.toFixed(2) + ' â‚¬';
Â  Â  Â  Â  Â  Â  document.getElementById('costoAggiuntivo').textContent = costoManodoperaAggiuntiva.toFixed(2) + ' â‚¬';
Â  Â  Â  Â  Â  Â  document.getElementById('totaleManodopera').textContent = totaleManodoperaArrotondato.toFixed(2) + ' â‚¬';

Â  Â  Â  Â  Â  Â  document.getElementById('resNIntervento').textContent = nIntervento || 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById('resData').textContent = formatDate(dataIntervento);
Â  Â  Â  Â  Â  Â  Â document.getElementById('resScuola').textContent = (nomeScuola || 'N/A') + (plessoEdificio ? ' / ' + plessoEdificio : '');
Â  Â  Â  Â  Â  Â  document.getElementById('resOrario').textContent = oraInizioInput + ' - ' + oraFineInput;
Â  Â  Â  Â  Â  Â  document.getElementById('resOperai').textContent = numOperai + (flagUrgenza ? ' (URGENZA)' : '');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Save / Delete / Load / Render (CORRETTE PER VERCEL) ---

Â  Â  Â  Â  // Mantenuto LOCALE per semplicitÃ , ma potresti spostarlo su server.
Â  Â  Â  Â  function salvaEmail() {
Â  Â  Â  Â  Â  Â  Â const email = document.getElementById('emailDestinatario').value.trim();
Â  Â  Â  Â  Â  Â  Â localStorage.setItem('defaultEmail', email);
Â  Â  Â  Â  Â  Â  Â showMessage('success', 'Email di destinazione salvata localmente.');
Â  Â  Â  Â  }

Â  Â  Â  Â  async function salvaIntervento() {
Â  Â  Â  Â  Â  Â  calcolaManodopera();

Â  Â  Â  Â  Â  Â  if (!document.getElementById('errorMsg').classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', "Impossibile salvare: ci sono errori nel calcolo.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const nInterventoCompleto = document.getElementById('nIntervento').value.trim();
Â  Â  Â  Â  Â  Â  const CURRENT_YEAR = new Date().getFullYear().toString().substring(2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (nInterventoCompleto.indexOf(CURRENT_YEAR) === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `Il 'NÂ° Intervento' non Ã¨ valido. Riprova o carica l'intervento.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Dati da inviare al server
Â  Â  Â  Â  Â  Â  const intervento = {
Â  Â  Â  Â  Â  Â  Â  Â  id: document.getElementById('nIntervento').dataset.id || null, // ID del DB se sto modificando
Â  Â  Â  Â  Â  Â  Â  Â  nIntervento: nInterventoCompleto,
Â  Â  Â  Â  Â  Â  Â  Â  dataIntervento: document.getElementById('dataIntervento').value,
Â  Â  Â  Â  Â  Â  Â  Â  nomeScuola: document.getElementById('nomeScuola').value,
Â  Â  Â  Â  Â  Â  Â  Â  plessoEdificio: document.getElementById('plessoEdificio').value,
Â  Â  Â  Â  Â  Â  Â  Â  oraInizio: document.getElementById('oraInizio').value,
Â  Â  Â  Â  Â  Â  Â  Â  oraFine: document.getElementById('oraFine').value,
Â  Â  Â  Â  Â  Â  Â  Â  numOperai: parseInt(document.getElementById('numOperai').value),
Â  Â  Â  Â  Â  Â  Â  Â  flagUrgenza: document.getElementById('flagUrgenza').checked,
Â  Â  Â  Â  Â  Â  Â  Â  tariffaOraria: document.getElementById('tariffaOraria').textContent,
Â  Â  Â  Â  Â  Â  Â  Â  totaleManodopera: document.getElementById('totaleManodopera').textContent
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const method = intervento.id ? 'PUT' : 'POST';
Â  Â  Â  Â  Â  Â  // CORREZIONE 3: Endpoint Vercel (chiamiamo /api/getIntervento come POST/PUT)
Â  Â  Â  Â  Â  Â  const endpoint = '/api/getIntervento'; 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Invia i dati al Server (Vercel Function)
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(endpoint, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: method,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(intervento)
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
                    const errorData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Stato HTTP: ${response.status} - ${errorData.error || 'Errore sconosciuto'}`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Aggiorna la UI
Â  Â  Â  Â  Â  Â  Â  Â  const azione = intervento.id ? 'aggiornato' : 'salvato';
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('success', `Intervento NÂ° ${result.nIntervento} ${azione} correttamente in rete!`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await resetFields();
Â  Â  Â  Â  Â  Â  Â  Â  if (!document.getElementById('archivioInterventi').classList.contains('hidden')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await renderArchivio();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `ERRORE (SERVER): Impossibile salvare in rete. Dettaglio: ${error.message}. Verifica l'API '${endpoint}'.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Carica un intervento dal server e popola i campi
Â  Â  Â  Â  async function caricaIntervento(id) {
Â  Â  Â  Â  Â  Â  // CORREZIONE 4: Endpoint Vercel
Â  Â  Â  Â  Â  Â  const endpoint = `/api/getIntervento?id=${id}`;

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Stato HTTP: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const intervento = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (intervento) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Riempie i campi, inclusi i dati del server
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nIntervento').value = intervento.nIntervento;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nIntervento').dataset.id = id; // Memorizza l'ID del DB
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dataIntervento').value = intervento.dataIntervento;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('nomeScuola').value = intervento.nomeScuola;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('plessoEdificio').value = intervento.plessoEdificio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('oraInizio').value = intervento.oraInizio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('oraFine').value = intervento.oraFine;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('numOperai').value = intervento.numOperai;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('flagUrgenza').checked = intervento.flagUrgenza;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calcolaManodopera(); // Riesegue il calcolo e riempie i totali

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleArchivio();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('success', `Intervento NÂ° ${intervento.nIntervento} caricato.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â showMessage('error', 'Intervento non trovato sul server.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `ERRORE (SERVER): Impossibile caricare l'intervento. Verifica l'API 'getIntervento'.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function cancellaIntervento(id) {
Â  Â  Â  Â  Â  Â  if (confirm("Sei sicuro di voler cancellare questo intervento? L'azione Ã¨ definitiva sul database!")) {
Â  Â  Â  Â  Â  Â  Â  Â  // CORREZIONE 5: Endpoint Vercel
Â  Â  Â  Â  Â  Â  Â  Â  const endpoint = `/api/deleteIntervento?id=${id}`;

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(endpoint, { method: 'DELETE' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Stato HTTP: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('success', `Intervento NÂ° ${result.nIntervento || '---'} cancellato dal server.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await renderArchivio();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await loadNextNIntervento(true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  calcolaManodopera();

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `ERRORE (SERVER): Impossibile cancellare. Verifica l'API 'deleteIntervento'.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function renderArchivio() {
Â  Â  Â  Â  Â  Â  const listaDiv = document.getElementById('listaInterventi');
Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = '<p class="text-gray-500">Caricamento interventi in corso...</p>';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // CORREZIONE 6: Endpoint Vercel
Â  Â  Â  Â  Â  Â  const endpoint = `/api/getArchivio`; // Ottieni tutti gli interventi

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Stato HTTP: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const interventi = await response.json(); // Array di interventi
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(interventi) || interventi.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = '<p class="text-gray-500">Nessun intervento salvato in rete. Usa il pulsante "Salva Intervento" per iniziare.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Ordina per NÂ° Intervento in modo decrescente
Â  Â  Â  Â  Â  Â  Â  Â  interventi.sort((a, b) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const numA = parseInt(a.nIntervento.split('/')[0]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const numB = parseInt(b.nIntervento.split('/')[0]);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return numB - numA;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = ''; // Pulisce la lista

Â  Â  Â  Â  Â  Â  Â  Â  interventi.forEach(i => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-3 border border-gray-200 rounded-lg shadow-sm bg-white flex justify-between items-center flex-wrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1 min-w-[50%]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg text-blue-700">NÂ° ${i.nIntervento} (${formatDate(i.dataIntervento)})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600">${i.nomeScuola || 'N/A'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2 mt-2 sm:mt-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="caricaIntervento('${i.id}')" class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Carica
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="cancellaIntervento('${i.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-2 px-3 rounded-md transition duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Elimina
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML += itemHtml;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('error', `ERRORE (SERVER): Impossibile caricare l'archivio. Dettaglio: ${error.message}.`);
Â  Â  Â  Â  Â  Â  Â  Â  listaDiv.innerHTML = '<p class="text-red-500">Errore nel caricamento dei dati.</p>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UI Functions (Stampa, Toggle) ---

Â  Â  Â  Â  function stampaRiepilogo() {
Â  Â  Â  Â  Â  Â  window.print();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function toggleArchivio() {
Â  Â  Â  Â  Â  Â  const archivioDiv = document.getElementById('archivioInterventi');
Â  Â  Â  Â  Â  Â  const isHidden = archivioDiv.classList.contains('hidden');

Â  Â  Â  Â  Â  Â  if (isHidden) {
Â  Â  Â  Â  Â  Â  Â  Â  archivioDiv.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnToggleArchivio').textContent = 'Nascondi Archivio';
Â  Â  Â  Â  Â  Â  Â  Â  await renderArchivio();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  archivioDiv.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnToggleArchivio').textContent = 'Gestione Archivio';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Funzione non implementata sul server (solo client-side)
Â  Â  Â  Â  function inviaReport() {
Â  Â  Â  Â  Â  Â  showMessage('error', "La funzione di invio email non Ã¨ ancora attiva in questo ambiente.");
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Inizializzazione ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  initializeInputs();
Â  Â  Â  Â  Â  Â  calcolaManodopera(); // Esegue un calcolo iniziale
Â  Â  Â  Â  });
Â  Â  </script>

</body>
</html>
