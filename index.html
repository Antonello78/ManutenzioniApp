<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manutenzioni D'Angelo - Calcolo Manodopera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .container { max-width: 100% !important; box-shadow: none !important; border: none !important; margin: 0 !important; }
            .bg-white { border: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans leading-tight">
    <div class="max-w-md mx-auto container">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-4 relative overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Manutenzioni D'Angelo</h1>
                    <p class="text-xs text-gray-500 italic">Interventi Manutenzione Scuole</p>
                </div>
                <div class="text-right">
                    <div id="numero-intervento" class="text-lg font-black text-blue-600">--/--</div>
                    <div id="last-modified" class="text-[10px] text-gray-400"></div>
                </div>
            </div>

            <div class="space-y-4 no-print">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1 caps">Scuola</label>
                    <input type="text" id="scuola" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Nome della scuola">
                </div>
                
                <div>
                    <label class="block text-xs font-semibold text-gray-600 mb-1">Dettaglio Plesso / Edificio</label>
                    <input type="text" id="plesso" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Es: Sede Centrale, Palestra...">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Data</label>
                        <input type="date" id="data" class="w-full border rounded p-2 text-sm outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">N° Operai</label>
                        <input type="number" id="operai" value="1" min="1" class="w-full border rounded p-2 text-sm outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Ora Inizio</label>
                        <input type="time" id="oraInizio" class="w-full border rounded p-2 text-sm outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Ora Fine</label>
                        <input type="time" id="oraFine" class="w-full border rounded p-2 text-sm outline-none">
                    </div>
                </div>

                <div class="flex items-center space-x-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                    <input type="checkbox" id="urgenza" class="w-4 h-4 text-yellow-600">
                    <label for="urgenza" class="text-xs font-bold text-yellow-800 uppercase tracking-wider">Intervento Urgente</label>
                </div>

                <button onclick="calcola()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow transition duration-200 uppercase text-sm tracking-widest">
                    Calcola Importo
                </button>
            </div>

            <div id="risultato" class="mt-8 border-t pt-6 hidden">
                <div class="space-y-3">
                    <div class="flex justify-between text-sm border-b pb-2">
                        <span class="text-gray-600">Data Intervento:</span>
                        <span id="resData" class="font-bold uppercase"></span>
                    </div>
                    <div class="flex justify-between text-sm border-b pb-2">
                        <span class="text-gray-600">Scuola:</span>
                        <span id="resScuola" class="font-bold uppercase"></span>
                    </div>
                    <div class="flex justify-between text-sm border-b pb-2">
                        <span class="text-gray-600">Plesso/Edificio:</span>
                        <span id="resPlesso" class="font-bold uppercase text-right max-w-[200px]"></span>
                    </div>
                    <div class="flex justify-between text-sm border-b pb-2">
                        <span class="text-gray-600 font-bold" id="resTariffaLabel">Tariffa:</span>
                        <span id="resTariffa" class="font-bold text-blue-700 uppercase"></span>
                    </div>
                    <div class="flex justify-between text-sm border-b pb-2">
                        <span class="text-gray-600 italic">Tempo Fatturabile:</span>
                        <span id="resTempo" class="font-bold"></span>
                    </div>
                    
                    <div class="space-y-1 bg-gray-50 p-3 rounded">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Costo di Uscita (Incl. 1ª Ora):</span>
                            <span id="resUscita" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Manodopera Aggiuntiva:</span>
                            <span id="resAggiuntiva" class="font-medium"></span>
                        </div>
                        <div class="flex justify-between text-base font-black border-t mt-2 pt-2 text-blue-800">
                            <span>TOTALE MANODOPERA:</span>
                            <span id="resTotale"></span>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-2 no-print">
                    <button onclick="window.print()" class="flex-1 bg-gray-800 hover:bg-black text-white py-3 rounded-lg font-bold text-xs uppercase tracking-tighter">
                        Stampa PDF
                    </button>
                    <button onclick="inviaReport()" id="btnInvia" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold text-xs uppercase tracking-tighter">
                        Invia Report
                    </button>
                </div>
            </div>

            <div class="text-center text-gray-400 text-[10px] mt-8 no-print border-t pt-4">
                Ditta D'Angelo Antonello — v1.0.1 (Release 2025)
            </div>

            <p class="mt-4 text-[10px] text-gray-400 text-center no-print">
                Orario Ordinario: 08:00 - 17:00. Il calcolo arrotonda i minuti di manodopera per eccesso al quarto d'ora superiore.
            </p>
        </div>
    </div>

    <script>
        // Costanti
        const ORARIO_INIZIO_ORD = 8 * 60; 
        const ORARIO_FINE_ORD = 17 * 60; 
        const STORAGE_KEY = 'manodoperaInterventi';
        const EMAIL_KEY = 'reportEmailDestinatario'; 
        const INIZIO_2025 = 74; 

        let datiCorrenti = null;

        document.getElementById('data').valueAsDate = new Date();

        async function caricaDatiServer() {
            try {
                const res = await fetch('/api/getContatore');
                const data = await res.json();
                const num = (INIZIO_2025 + data.count).toString().padStart(3, '0');
                document.getElementById('numero-intervento').textContent = `${num}/25`;
            } catch (e) {
                document.getElementById('numero-intervento').textContent = 'ERR/25';
            }
        }

        function updateLastModifiedText() {
            const now = new Date();
            document.getElementById('last-modified').textContent = 
                `Ultimo avvio: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
        }

        function calcola() {
            const scuola = document.getElementById('scuola').value;
            const plesso = document.getElementById('plesso').value;
            const dataInput = document.getElementById('data').value;
            const operai = parseInt(document.getElementById('operai').value);
            const oraInizio = document.getElementById('oraInizio').value;
            const oraFine = document.getElementById('oraFine').value;
            const urgenza = document.getElementById('urgenza').checked;

            if (!scuola || !oraInizio || !oraFine) {
                alert("Inserisci Scuola e Orari!");
                return;
            }

            const [hIn, mIn] = oraInizio.split(':').map(Number);
            const [hOut, mOut] = oraFine.split(':').map(Number);
            
            const inizioInMinuti = hIn * 60 + mIn;
            const fineInMinuti = hOut * 60 + mOut;
            const durataMinutiEffettivi = fineInMinuti - inizioInMinuti;

            if (durataMinutiEffettivi <= 0) {
                alert("L'ora di fine deve essere successiva all'ora di inizio!");
                return;
            }

            const durataArrotondata = Math.ceil(durataMinutiEffettivi / 15) * 15;
            
            let isStraordinario = urgenza;
            if (inizioInMinuti < ORARIO_INIZIO_ORD || fineInMinuti > ORARIO_FINE_ORD) {
                isStraordinario = true;
            }

            const tariffaUscita = isStraordinario ? 45.00 : 35.00;
            const tariffaOraria = isStraordinario ? 37.50 : 30.00;

            const oreAggiuntive = Math.max(0, (durataArrotondata - 60) / 60);
            const costoUscitaTotale = tariffaUscita * operai;
            const costoManodoperaAggiuntiva = oreAggiuntive * tariffaOraria * operai;
            const totale = costoUscitaTotale + costoManodoperaAggiuntiva;

            const oreIntere = Math.floor(durataArrotondata / 60);
            const minutiRimanenti = durataArrotondata % 60;
            const tempoFatturabile = `${oreIntere}h ${minutiRimanenti}min`;

            datiCorrenti = {
                numero: document.getElementById('numero-intervento').textContent,
                scuola: scuola.toUpperCase(),
                plesso: plesso.toUpperCase(),
                data: new Date(dataInput).toLocaleDateString('it-IT'),
                orario: `${oraInizio} - ${oraFine}`,
                operai: operai,
                tariffaLabel: isStraordinario ? "STRAORDINARIA / URGENZA" : "ORDINARIA",
                tempo: tempoFatturabile,
                uscita: costoUscitaTotale.toFixed(2),
                aggiuntiva: costoManodoperaAggiuntiva.toFixed(2),
                totale: totale.toFixed(2)
            };

            document.getElementById('resData').textContent = datiCorrenti.data;
            document.getElementById('resScuola').textContent = datiCorrenti.scuola;
            document.getElementById('resPlesso').textContent = datiCorrenti.plesso;
            document.getElementById('resTariffa').textContent = datiCorrenti.tariffaLabel;
            document.getElementById('resTempo').textContent = tempoFatturabile;
            document.getElementById('resUscita').textContent = `€ ${datiCorrenti.uscita}`;
            document.getElementById('resAggiuntiva').textContent = `€ ${datiCorrenti.aggiuntiva}`;
            document.getElementById('resTotale').textContent = `€ ${datiCorrenti.totale}`;
            
            document.getElementById('risultato').classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        async function inviaReport() {
            if (!datiCorrenti) return;
            
            const btn = document.getElementById('btnInvia');
            const originalText = btn.innerHTML;
            
            let email = localStorage.getItem(EMAIL_KEY) || "";
            const nuovaEmail = prompt("Invia report a:", email);
            
            if (nuovaEmail === null) return;
            if (nuovaEmail) localStorage.setItem(EMAIL_KEY, nuovaEmail);

            btn.disabled = true;
            btn.innerHTML = "INVIO IN CORSO...";

            try {
                const response = await fetch('/api/inviaReport', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        destinatario: nuovaEmail,
                        dati: datiCorrenti
                    })
                });

                if (response.ok) {
                    alert("Report inviato con successo!");
                    await caricaDatiServer();
                } else {
                    alert("Errore durante l'invio.");
                }
            } catch (e) {
                alert("Errore di connessione.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        caricaDatiServer();
        updateLastModifiedText();

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
