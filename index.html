<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolo Manodopera App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
        
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            padding-top: 1rem;
         }
        /* Style specific to hide the number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* üõ†Ô∏è INIZIO BLOCCO CRITICO PER LA STAMPA üõ†Ô∏è */
        @media print {
            /* 1. NASCONDI TUTTO CI√í CHE NON √à NECESSARIO */
            .no-print,
            #input-section > div:not(.border-t) { 
                display: none !important;
            }
            
            /* Forza la visualizzazione della sezione calcolo e riepilogo */
            #input-section {
                display: block !important;
            }
            
            /* 2. LAYOUT E SCALA DELLA PAGINA A4 */
            body {
                padding: 0;
                background-color: white;
                margin: 0; 
            }
            #app {
                box-shadow: none !important;
                border: none !important;
                max-width: none !important;
                margin: 0 !important; 
                padding: 0.5rem !important; 
                
                width: 210mm; 
                min-height: 297mm; 
                
                transform: scale(0.85); 
                transform-origin: top left; 

                page-break-inside: avoid !important; 
            }
            
            /* 3. STILE DELL'HEADER (CON LOGO) PER LA STAMPA */
            #unified-header {
                 display: flex !important; /* Rendi visibile l'header e usa flexbox per allineamento */
                 padding-bottom: 0.5rem;
                 margin-bottom: 1rem;
                 border-bottom: 2px solid #ccc;
                 justify-content: space-between !important;
                 align-items: center !important;
            }

            /* üí• CORREZIONE LOGO: Forza la visualizzazione dell'immagine del logo */
            #unified-header img {
                display: block !important;
                visibility: visible !important;
            }

            /* 4. MANTIENI I BLOCCHI UNIFICATI */
            .print-avoid-break,
            .print-avoid-break *,
            .flex {
                page-break-inside: avoid !important;
            }

            /* 5. MARGINI DI STAMPA DEL BROWSER (CRITICO) */
            @page {
                size: A4 portrait; 
                margin: 0.5cm !important; 
            }
        }
        /* üõ†Ô∏è FINE BLOCCO CRITICO PER LA STAMPA üõ†Ô∏è */
    </style>
    </head>
<body class="antialiased">
    <div id="app" class="max-w-4xl mx-auto p-6 bg-white shadow-xl rounded-xl">
        
        <div class="no-print">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-4 text-center">Calcolo Manodopera</h1>
            <div class="flex justify-center mb-4 space-x-4">
                <button @click="showArchive = false; getNextInterventoNumber()" :class="{'bg-blue-600 text-white': !showArchive, 'bg-gray-200 text-gray-700': showArchive}" class="px-4 py-2 rounded-lg font-semibold transition">
                    Nuovo Intervento
                </button>
                <button @click="toggleArchive" :class="{'bg-blue-600 text-white': showArchive, 'bg-gray-200 text-gray-700': !showArchive}" class="px-4 py-2 rounded-lg font-semibold transition">
                    Archivio ({{ archive.length }})
                </button>
            </div>
            <hr class="mb-6">
        </div>

        <div v-if="showArchive" class="no-print">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Archivio Interventi</h2>
            <div v-if="archive.length === 0" class="text-center py-10 text-gray-500">
                Nessun intervento salvato nell'archivio cloud.
            </div>
            <div v-else class="space-y-4">
                <div v-for="item in sortedArchive" :key="item.key" class="p-4 border rounded-lg shadow-sm flex justify-between items-center bg-white hover:bg-gray-50 transition">
                    <div>
                        <p class="font-bold text-lg text-blue-700">{{ item.nIntervento }}</p>
                        <p class="text-sm text-gray-600">{{ item.nomeScuola }} - {{ item.dataIntervento }}</p>
                    </div>
                    <div class="flex space-x-2 items-center">
                        <button @click="loadIntervento(item)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 text-sm rounded transition">
                            Carica
                        </button>
                        <button @click="deleteIntervento(item.key)" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 text-sm rounded transition">
                            Elimina
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-else>
            
            <header id="unified-header" class="print-avoid-break flex justify-between items-center mb-6">
                <img src="./img/LOGO ANTONELLO.png" alt="Logo Aziendale" class="h-10"> 
                
                <div class="text-right">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 font-semibold w-24">N¬∞ Intervento:</label>
                        <input type="text" v-model="nIntervento" readonly class="text-xl font-bold text-blue-700 bg-gray-100 p-1 w-32 rounded text-center">
                    </div>
                    <div class="flex items-center space-x-2 mt-1">
                        <label for="dataIntervento" class="text-gray-600 font-semibold w-24">Data:</label>
                        <input type="date" id="dataIntervento" v-model="dataIntervento" class="bg-white border border-gray-300 p-1 w-32 rounded text-center">
                    </div>
                </div>
            </header>

            <section id="input-section" class="space-y-4 no-print mb-6">
                
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Dati Intervento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nomeScuola" class="block text-sm font-medium text-gray-700">Scuola (Nome Intero)</label>
                        <input type="text" id="nomeScuola" v-model="nomeScuola" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="plessoEdificio" class="block text-sm font-medium text-gray-700">Plesso/Edificio</label>
                        <input type="text" id="plessoEdificio" v-model="plessoEdificio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="orarioInizio" class="block text-sm font-medium text-gray-700">Orario Inizio</label>
                        <input type="time" id="orarioInizio" v-model="orarioInizio" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="orarioFine" class="block text-sm font-medium text-gray-700">Orario Fine</label>
                        <input type="time" id="orarioFine" v-model="orarioFine" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="operai" class="block text-sm font-medium text-gray-700">Numero Operai</label>
                        <input type="number" id="operai" v-model.number="operai" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-center">
                    </div>
                    <div>
                        <label for="tariffa" class="block text-sm font-medium text-gray-700">Tariffa Oraria (‚Ç¨)</label>
                        <input type="number" id="tariffa" v-model.number="tariffa" min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm text-center">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t print-avoid-break">
                    <button @click="saveIntervento" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">
                        Salva e Sincronizza
                    </button>
                    <button @click="printReport" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md">
                        Stampa Riepilogo / Crea PDF
                    </button>
                </div>
            </section>
            
            <hr class="no-print my-6">

            <section id="calcolo-section" class="space-y-4 pt-4">
                <h2 class="text-xl font-bold text-gray-800 border-b pb-2">Riepilogo e Calcolo</h2>

                <div class="print-avoid-break bg-gray-50 p-4 rounded-lg shadow-inner">
                    <div class="flex justify-between font-semibold text-lg border-b pb-2 mb-2">
                        <span>Tempo Lavorato Totale:</span>
                        <span class="text-gray-800">{{ orarioLavoratoTotale }}</span>
                    </div>
                    <div class="flex justify-between font-semibold text-lg">
                        <span>Minuti Fatturabili (Arrotondati):</span>
                        <span class="text-blue-700">{{ minutiFatturabili }} min</span>
                    </div>
                </div>

                <div class="print-avoid-break bg-white p-4 rounded-lg border-2 border-green-500 shadow-lg">
                    <h3 class="text-2xl font-extrabold text-green-700 mb-4 text-center">Totale Fattura Manodopera</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Costo di Uscita (Incl. 1¬™ Ora)</p>
                            <p class="text-xl font-bold text-gray-800">{{ costoUscita }} ‚Ç¨</p>
                        </div>
                        <div class="text-center p-3 bg-green-50 rounded-lg">
                            <p class="text-sm font-medium text-gray-600">Costo Manodopera Aggiuntiva</p>
                            <p class="text-xl font-bold text-gray-800">{{ costoAggiuntivo }} ‚Ç¨</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center bg-green-600 p-4 rounded-lg text-white">
                        <span class="text-2xl font-extrabold">TOTALE COMPLESSIVO:</span>
                        <span class="text-3xl font-extrabold">{{ totaleCosto }} ‚Ç¨</span>
                    </div>
                </div>
            </section>

            <section class="no-print mt-6 pt-6 border-t border-gray-200">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Invio Report via Email</h2>
                
                <div class="flex space-x-3 items-end">
                    <div class="flex-grow">
                        <label for="destinatarioEmail" class="block text-sm font-medium text-gray-700">Email Destinatario</label>
                        <input type="email" id="destinatarioEmail" v-model="destinatarioEmail" placeholder="esempio@scuola.it" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <button @click="inviaReport" :disabled="!destinatarioEmail" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition shadow-md disabled:bg-red-300">
                        Invia Report
                    </button>
                </div>
                
                <p v-if="statusMessage" :class="statusType === 'success' ? 'text-green-600' : 'text-red-600'" class="mt-2 font-medium">
                    {{ statusMessage }}
                </p>
            </section>

        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // Dati Intervento
                const nIntervento = ref('');
                const dataIntervento = ref(new Date().toISOString().slice(0, 10));
                const nomeScuola = ref('');
                const plessoEdificio = ref('');
                const orarioInizio = ref('08:00');
                const orarioFine = ref('09:00');
                const operai = ref(1);
                const tariffa = ref(48.00); // Valore predefinito
                
                // Stato
                const showArchive = ref(false);
                const archive = ref([]);
                const statusMessage = ref('');
                const statusType = ref('');
                const lastInterventoKey = ref(null); // Usato per l'eliminazione

                // Calcoli
                const tempoTotaleMinuti = computed(() => {
                    const start = orarioInizio.value;
                    const end = orarioFine.value;

                    if (!start || !end) return 0;

                    const [h1, m1] = start.split(':').map(Number);
                    const [h2, m2] = end.split(':').map(Number);

                    const totalMinutes1 = h1 * 60 + m1;
                    const totalMinutes2 = h2 * 60 + m2;

                    let diff = totalMinutes2 - totalMinutes1;

                    // Gestione cambio giorno (se fine √® minore di inizio, aggiunge 24h)
                    if (diff < 0) {
                        diff += 24 * 60; 
                    }
                    
                    return diff * operai.value;
                });
                
                const orarioLavoratoTotale = computed(() => {
                    const totalMinutes = tempoTotaleMinuti.value;
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    return `${hours} ore e ${minutes} min`;
                });

                const minutiFatturabili = computed(() => {
                    // Arrotondamento all'ora successiva se > 5 min
                    let total = tempoTotaleMinuti.value;
                    if (total === 0) return 0;
                    
                    // Prima ora intera (60 min)
                    if (total <= 60) return 60;
                    
                    // Minuti oltre la prima ora
                    const minutiOltrePrimaOra = total - 60;
                    
                    // Arrotondamento ai 15 minuti successivi
                    const resto = minutiOltrePrimaOra % 15;
                    let minutiAggiuntivi;

                    if (resto === 0) {
                        minutiAggiuntivi = minutiOltrePrimaOra;
                    } else if (resto <= 5) {
                        minutiAggiuntivi = minutiOltrePrimaOra - resto; // Arrotonda in basso al quarto d'ora
                    } else {
                        minutiAggiuntivi = minutiOltrePrimaOra + (15 - resto); // Arrotonda in alto al quarto d'ora
                    }
                    
                    return 60 + minutiAggiuntivi; // 60 minuti base + minuti aggiuntivi arrotondati
                });

                const costoUscita = computed(() => {
                    // La prima ora (60 min) √® sempre inclusa nel costo di uscita
                    return (Math.min(60, minutiFatturabili.value) / 60) * tariffa.value;
                });

                const costoAggiuntivo = computed(() => {
                    const minutiAggiuntivi = Math.max(0, minutiFatturabili.value - 60);
                    return (minutiAggiuntivi / 60) * tariffa.value;
                });

                const totaleCosto = computed(() => {
                    return (costoUscita.value + costoAggiuntivo.value).toFixed(2);
                });


                // API Calls
                const fetchArchive = async () => {
                    try {
                        const response = await fetch('/api/getArchivio');
                        if (!response.ok) throw new Error('API Archive non disponibile.');
                        const data = await response.json();
                        archive.value = data.map(item => ({
                            ...item.value,
                            key: item.key 
                        }));
                    } catch (error) {
                        console.error("Errore caricamento archivio:", error);
                        statusMessage.value = `Errore Archivio: ${error.message}`;
                        statusType.value = 'error';
                    }
                };
                
                const getNextInterventoNumber = async () => {
                    try {
                        const year = new Date(dataIntervento.value).getFullYear().toString().slice(-2);
                        const response = await fetch(`/api/getNextNumber?year=${year}`);
                        if (!response.ok) throw new Error('API Contatore non disponibile.');
                        const nextNumber = await response.json();
                        
                        const seq = (nextNumber.value + 1).toString().padStart(3, '0');
                        nIntervento.value = `${seq}/${year}`;

                    } catch (error) {
                        console.error("Errore contatore:", error);
                        nIntervento.value = `001/${new Date().getFullYear().toString().slice(-2)}`;
                    }
                };

                const saveIntervento = async () => {
                    statusMessage.value = 'Salvataggio e sincronizzazione in corso...';
                    statusType.value = 'info';

                    const payload = {
                        nIntervento: nIntervento.value,
                        dataIntervento: dataIntervento.value,
                        nomeScuola: nomeScuola.value,
                        plessoEdificio: plessoEdificio.value,
                        orarioInizio: orarioInizio.value,
                        orarioFine: orarioFine.value,
                        orario: orarioLavoratoTotale.value,
                        operai: operai.value,
                        tariffa: tariffa.value.toFixed(2),
                        minutiFatturabili: minutiFatturabili.value,
                        costoUscita: costoUscita.value.toFixed(2),
                        costoAggiuntivo: costoAggiuntivo.value.toFixed(2),
                        totale: totaleCosto.value,
                        // Il 'key' √® necessario se si tratta di un aggiornamento
                        key: lastInterventoKey.value 
                    };

                    try {
                        const response = await fetch('/api/saveIntervento', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Errore server sconosciuto.');
                        }

                        // Se √® un nuovo salvataggio, aggiorna l'archivio e resetta la chiave
                        if (!lastInterventoKey.value) {
                             fetchArchive();
                             lastInterventoKey.value = data.key;
                             // Aggiorna il contatore per il prossimo intervento
                             getNextInterventoNumber(); 
                        }

                        statusMessage.value = 'Salvataggio cloud completato e sincronizzato!';
                        statusType.value = 'success';
                        
                    } catch (error) {
                        console.error("Errore salvataggio/sincronizzazione:", error);
                        statusMessage.value = `Salvataggio/sincronizzazione fallita: ${error.message}`;
                        statusType.value = 'error';
                    }
                };
                
                const deleteIntervento = async (key) => {
                    if (!confirm(`Sei sicuro di voler eliminare l'intervento ${key.split(':').pop()}?`)) return;

                    try {
                        const response = await fetch('/api/deleteIntervento', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ key })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Errore server sconosciuto.');
                        }

                        statusMessage.value = `Intervento ${key.split(':').pop()} eliminato con successo.`;
                        statusType.value = 'success';
                        
                        // Ricarica l'archivio e resetta la form se l'intervento eliminato era quello caricato
                        fetchArchive();
                        if (key === lastInterventoKey.value) {
                            resetForm();
                        }

                    } catch (error) {
                        console.error("Errore eliminazione:", error);
                        statusMessage.value = `Eliminazione fallita: ${error.message}`;
                        statusType.value = 'error';
                    }
                };

                const inviaReport = async () => {
                    if (!destinatarioEmail.value) {
                         statusMessage.value = 'Inserisci l\'indirizzo email del destinatario.';
                         statusType.value = 'error';
                         return;
                    }

                    statusMessage.value = 'Invio report in corso...';
                    statusType.value = 'info';
                    
                    const payload = {
                        nIntervento: nIntervento.value,
                        dataIntervento: dataIntervento.value,
                        nomeScuola: nomeScuola.value,
                        plessoEdificio: plessoEdificio.value,
                        orario: orarioLavoratoTotale.value,
                        operai: operai.value,
                        tariffa: tariffa.value.toFixed(2),
                        minutiFatturabili: `${minutiFatturabili.value} min`,
                        costoUscita: costoUscita.value.toFixed(2) + ' ‚Ç¨',
                        costoAggiuntivo: costoAggiuntivo.value.toFixed(2) + ' ‚Ç¨',
                        totale: totaleCosto.value + ' ‚Ç¨',
                        destinatario: destinatarioEmail.value
                    };

                    try {
                        // üö® CHIAMATA API MODIFICATA PER COMPATIBILIT√Ä:
                        const response = await fetch('/api/report', { // Usa /api/report (se rinominato) o /api/inviaReport
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.message || 'Errore server sconosciuto.');
                        }

                        statusMessage.value = data.message || 'Report inviato con successo!';
                        statusType.value = 'success';

                    } catch (error) {
                        console.error("Errore invio report:", error);
                        statusMessage.value = `Errore durante l'invio del report: ${error.message}`;
                        statusType.value = 'error';
                    }
                };

                // Funzioni di Utilit√†
                const sortedArchive = computed(() => {
                    return archive.value.sort((a, b) => {
                        const numA = parseInt(a.nIntervento.split('/')[0]);
                        const numB = parseInt(b.nIntervento.split('/')[0]);
                        return numB - numA; // Ordine decrescente
                    });
                });

                const resetForm = () => {
                    nomeScuola.value = '';
                    plessoEdificio.value = '';
                    orarioInizio.value = '08:00';
                    orarioFine.value = '09:00';
                    operai.value = 1;
                    tariffa.value = 48.00;
                    lastInterventoKey.value = null;
                    statusMessage.value = '';
                    statusType.value = '';
                    getNextInterventoNumber();
                };

                const loadIntervento = (item) => {
                    resetForm(); // Pulisce prima di caricare
                    showArchive.value = false;
                    
                    nIntervento.value = item.nIntervento;
                    dataIntervento.value = item.dataIntervento;
                    nomeScuola.value = item.nomeScuola;
                    plessoEdificio.value = item.plessoEdificio;
                    orarioInizio.value = item.orarioInizio;
                    orarioFine.value = item.orarioFine;
                    operai.value = item.operai;
                    tariffa.value = parseFloat(item.tariffa);
                    lastInterventoKey.value = item.key; // Imposta la chiave per un potenziale aggiornamento

                    statusMessage.value = `Intervento ${item.nIntervento} caricato per la modifica.`;
                    statusType.value = 'info';
                };
                
                const toggleArchive = () => {
                    showArchive.value = !showArchive.value;
                    if (showArchive.value) {
                        fetchArchive();
                    } else {
                        // Quando si torna alla form principale, la resetta
                        resetForm(); 
                    }
                };
                
                const printReport = () => {
                    window.print();
                };

                // Invio Email
                const destinatarioEmail = ref('');


                onMounted(() => {
                    getNextInterventoNumber();
                });

                // Watchers per aggiornare il contatore se l'anno cambia
                Vue.watch(dataIntervento, () => {
                    if (!showArchive.value) {
                         getNextInterventoNumber();
                    }
                });

                return {
                    nIntervento, dataIntervento, nomeScuola, plessoEdificio, orarioInizio, orarioFine, operai, tariffa,
                    tempoTotaleMinuti, orarioLavoratoTotale, minutiFatturabili, costoUscita, costoAggiuntivo, totaleCosto,
                    saveIntervento, loadIntervento, deleteIntervento, printReport, inviaReport,
                    fetchArchive, getNextInterventoNumber,
                    showArchive, archive, sortedArchive, toggleArchive,
                    statusMessage, statusType, destinatarioEmail
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
